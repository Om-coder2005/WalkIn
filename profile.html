<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile - WalkIn</title>
  <style>
    :root{
      --primary:#6c574c;
      --primary-dark:#5a4940;
      --accent:#4e6758;
      --accent-light:#668673;
      --bg:#fbf9f4;
      --surface:#fefefe;
      --text:#30251f;
      --text-light:#5e534f;
      --muted:#8b7f75;
      --border:#c7bfba;
      --border-light:#e5e0dc;
      --shadow:0 2px 4px rgba(0,0,0,0.05);
      --shadow-lg:0 5px 15px rgba(0,0,0,0.08);
      --shadow-xl:0 10px 30px rgba(0,0,0,0.15);
      --radius:10px;
      --radius-lg:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.6;
      font-size:15px;
      padding:20px;
    }
    .container{
      max-width:800px;
      margin:0 auto;
      position: relative;
    }
    h1{
      font-family:'Caveat',cursive;
      font-size:2.5rem;
      color:var(--text);
      text-align:center;
      margin-bottom:10px;
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      margin-bottom:30px;
    }
    .profile-form{
      background:var(--surface);
      border-radius:var(--radius-lg);
      padding:30px;
      box-shadow:var(--shadow-lg);
      margin-bottom:30px;
    }
    .profile-form.hidden{display:none}
    .form-section{margin-bottom:30px}
    .section-title{
      font-family:'Caveat',cursive;
      font-size:1.4rem;
      color:var(--primary);
      margin-bottom:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
    }
    .form-field{margin-bottom:20px}
    .form-field.full-width{grid-column:1/-1}
    label{
      display:block;
      margin-bottom:8px;
      font-weight:600;
      color:var(--text-light);
      font-size:14px;
    }
    .required{color:var(--primary)}
    input,textarea,select{
      width:100%;
      padding:12px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      font-size:14px;
      font-family:inherit;
      background:var(--surface);
      transition:border-color 0.2s;
    }
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:var(--primary);
    }
    textarea{
      min-height:100px;
      resize:vertical;
    }
    .image-upload-section{
      text-align:center;
      margin-bottom:30px;
    }
    .profile-image-preview{
      width:100px;
      height:100px;
      border-radius:50%;
      background:var(--primary);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:2rem;
      font-weight:700;
      cursor:pointer;
      overflow:hidden;
      margin-bottom:10px;
      transition:transform 0.2s;
    }
    .profile-image-preview:hover{
      transform:scale(1.05);
    }
    .profile-image-preview img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    #imageUpload{display:none}
    .availability-toggle{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .toggle{
      width:50px;
      height:26px;
      background:var(--border);
      border-radius:13px;
      cursor:pointer;
      position:relative;
      transition:background 0.3s;
    }
    .toggle.active{background:var(--accent)}
    .toggle::after{
      content:'';
      position:absolute;
      top:2px;
      left:2px;
      width:22px;
      height:22px;
      background:white;
      border-radius:50%;
      transition:left 0.3s;
      box-shadow:var(--shadow);
    }
    .toggle.active::after{left:26px}
    .btn{
      padding:12px 24px;
      border:none;
      border-radius:var(--radius);
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btn-primary{
      background:var(--primary);
      color:white;
    }
    .btn-primary:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
    }
    .btn-secondary{
      background:var(--border-light);
      color:var(--text);
    }
    .btn-secondary:hover{
      background:var(--border);
    }
    .btn-edit{
      background:var(--accent);
      color:white;
    }
    .btn-edit:hover{
      background:var(--accent-light);
      transform:translateY(-1px);
    }
    .form-actions{
      display:flex;
      gap:16px;
      justify-content:center;
      margin-top:30px;
    }
    .profile-card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      padding:30px;
      box-shadow:var(--shadow-lg);
      display:none;
      margin-bottom:20px;
    }
    .profile-card.show{
      display:block;
      animation:slideIn 0.4s ease;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    .card-header{
      text-align:center;
      padding-bottom:20px;
      border-bottom:1px dashed var(--border);
      margin-bottom:20px;
    }
    .card-profile-image{
      width:80px;
      height:80px;
      border-radius:50%;
      background:var(--primary);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:1.8rem;
      margin-bottom:15px;
      overflow:hidden;
    }
    .card-profile-image img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .card-name{
      font-size:1.6rem;
      font-weight:700;
      color:var(--primary);
      margin-bottom:5px;
    }
    .card-title{
      color:var(--text-light);
      margin-bottom:10px;
    }
    .availability-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:20px;
      font-size:13px;
      font-weight:600;
    }
    .availability-badge.available{
      background:rgba(78,103,88,0.1);
      color:var(--accent);
    }
    .availability-badge.unavailable{
      background:rgba(139,127,117,0.1);
      color:var(--muted);
    }
    .card-content{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    .card-section{
      padding:15px;
      background:rgba(108,87,76,0.03);
      border-radius:var(--radius);
    }
    .card-section.full-width{grid-column:1/-1}
    .card-section h3{
      font-size:1rem;
      color:var(--primary);
      margin-bottom:12px;
      font-weight:600;
    }
    .info-item{
      margin-bottom:8px;
      font-size:14px;
    }
    .info-label{
      font-weight:600;
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .skills-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .skill-tag{
      background:var(--primary);
      color:white;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
    }
    .card-actions{
      text-align:center;
      padding-top:20px;
      border-top:1px dashed var(--border);
    }
    .activity-sections{
      gap:20px;
      margin-top:30px;
      display: block;
    }
    .activity-sections.hidden{display:none}
    .success-message{
      background:var(--accent);
      color:white;
      padding:12px;
      border-radius:var(--radius);
      text-align:center;
      margin-bottom:20px;
      display:none;
    }
    .success-message.show{
      display:block;
      animation:slideIn 0.3s ease;
    }
    .activity-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        background: var(--border-light);
        border-radius: var(--radius);
        padding: 4px;
    }
    .tab-button {
        flex: 1;
        background: none;
        border: none;
        padding: 12px;
        border-radius: calc(var(--radius) - 2px);
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    .tab-button.active {
        background: var(--surface);
        color: var(--text);
        box-shadow: var(--shadow);
    }
    .tab-content {
        padding: 20px 0;
        min-height: 200px;
        border-top: 1px dashed var(--border);
    }
    .tab-content.hidden { display: none; }
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(2px);
        overflow-y: auto;
        padding: 20px 0;
    }
    .modal-content {
        background: var(--bg);
        border-radius: var(--radius-lg);
        padding: 30px;
        box-shadow: var(--shadow-xl);
        max-width: 500px;
        width: 90%;
        animation: slideIn 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-content h3 {
        font-family: 'Caveat', cursive;
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 20px;
        text-align: center;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .applicant-item {
        border: 1px solid var(--border);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: var(--radius);
        background: var(--surface);
    }
    .applicant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .applicant-info h4 {
        color: var(--primary);
        margin: 0 0 5px 0;
    }
    .applicant-info p {
        font-size: 13px;
        color: var(--text-light);
        margin: 2px 0;
    }
    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .status-pending { background: rgba(255, 193, 7, 0.2); color: #f57c00; }
    .status-accepted { background: rgba(76, 175, 80, 0.2); color: #2e7d32; }
    .status-rejected { background: rgba(244, 67, 54, 0.2); color: #c62828; }

    @media (max-width:768px){
      .form-grid,.card-content{grid-template-columns:1fr}
      .form-actions{flex-direction:column}
      .btn{width:100%}
    }
        /* ============================================ */
    /* APPLICANTS MODAL STYLES */
    /* ============================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 30px;
      width: 100%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      position: relative;
    }

    .applicant-item {
      border: 1px solid var(--border);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: var(--radius);
      background: var(--bg);
      transition: all 0.2s ease;
    }

    .applicant-item:hover {
      box-shadow: var(--shadow);
      border-color: var(--accent);
    }

    .applicant-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
      flex-wrap: wrap;
    }

    .applicant-info {
      flex: 1;
      min-width: 200px;
    }

    .applicant-info h4 {
      margin: 0 0 8px 0;
      color: var(--primary);
      font-size: 16px;
    }

    .applicant-info p {
      margin: 4px 0;
      font-size: 14px;
      color: var(--text-light);
    }

    /* Enhanced Status Badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      display: inline-block;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.15);
      color: #f57c00;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .status-accepted {
      background: rgba(76, 175, 80, 0.15);
      color: #2e7d32;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .status-rejected {
      background: rgba(244, 67, 54, 0.15);
      color: #c62828;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .status-in-progress {
      background: rgba(33, 150, 243, 0.15);
      color: #1976d2;
      border: 1px solid rgba(33, 150, 243, 0.3);
    }

    .status-awaiting-payment {
      background: rgba(156, 39, 176, 0.15);
      color: #7b1fa2;
      border: 1px solid rgba(156, 39, 176, 0.3);
    }

    .status-completed {
      background: rgba(76, 175, 80, 0.2);
      color: #1b5e20;
      border: 1px solid rgba(76, 175, 80, 0.4);
    }

    /* Rejection reason display */
    .rejection-box {
      margin-top: 15px;
      padding: 15px;
      background: rgba(244, 67, 54, 0.1);
      border-radius: var(--radius);
      border-left: 4px solid #c62828;
    }

    .rejection-box p {
      margin: 0;
      color: #c62828;
      font-weight: 600;
    }

    /* Hours Input Styling */
#hours-input:focus {
  outline: none;
  border-color: #9c27b0;
  box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
}

#hours-input::-webkit-inner-spin-button,
#hours-input::-webkit-outer-spin-button {
  opacity: 1;
}

/* Smooth transitions */
.modal-overlay {
  transition: opacity 0.2s ease;
}
.job-card {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.job-card:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}
/* Star Rating Styles */
.star {
  color: #ddd;
  transition: color 0.2s;
  display: inline-block;
  cursor: pointer;
}

.star:hover,
.star.active {
  color: #ffc107;
}

#star-rating:hover .star {
  color: #ffc107;
}

#star-rating .star:hover ~ .star {
  color: #ddd !important;
}

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>My Profile</h1>
    <p class="subtitle" id="subtitleText">Complete your profile to connect with opportunities.</p>
    <div class="success-message" id="successMessage">Profile updated successfully!</div>
    <div class="profile-card" id="profileCard"></div>
    
    <div class="activity-sections hidden" id="activitySections">
        <div class="activity-tabs">
            <button class="tab-button active" data-tab="posts">My Posts</button>
            <button class="tab-button" data-tab="applied">Applied Jobs</button>
            <button class="tab-button" data-tab="completed">Completed Jobs</button>
        </div>
        
       <div class="tab-content" id="tab-posts">
            <button class="btn btn-primary" id="createPostTabBtn" style="width: auto; padding: 8px 16px; margin-bottom: 20px;">
                + Create New Post
            </button>
            <div id="postsList">
                <p style="text-align: center; color: var(--muted);">Loading your posts...</p>
            </div>
        </div>
        
        <div class="tab-content hidden" id="tab-applied">
            <p style="text-align: center; color: var(--muted); margin-bottom: 20px;">Jobs you have applied for will appear here.</p>
            <div id="appliedList"></div>
        </div>

        <div class="tab-content hidden" id="tab-completed">
            <p style="text-align: center; color: var(--muted);">Your completed professional work will appear here.</p>
            <div id="completedList"></div>
        </div>
    </div>
    
    <form class="profile-form hidden" id="profileForm">
      <div class="image-upload-section">
        <div class="profile-image-preview" id="profileImagePreview"><span id="profileInitial">U</span></div>
        <input type="file" id="imageUpload" accept="image/*">
        <p style="color:var(--muted);font-size:13px">Click to upload profile picture</p>
      </div>
      <div class="form-section">
        <h3 class="section-title">üë§ Basic Information</h3>
        <div class="form-grid">
          <div class="form-field"><label>Username <span class="required">*</span></label><input type="text" id="username" required></div>
          <div class="form-field"><label>Email <span class="required">*</span></label><input type="email" id="email" required></div>
          <div class="form-field"><label>Phone Number</label><input type="tel" id="phone"></div>
          <div class="form-field"><label>Education</label><select id="education"><option value="">Select Education</option><option value="High School">High School</option><option value="Diploma">Diploma</option><option value="Bachelor's">Bachelor's Degree</option><option value="Master's">Master's Degree</option><option value="PhD">PhD</option></select></div>
        </div>
      </div>
      <div class="form-section">
        <h3 class="section-title">üíº Professional Information</h3>
        <div class="form-grid">
          <div class="form-field"><label>Occupation</label><input type="text" id="occupation" placeholder="e.g., Designer, Teacher"></div>
          <div class="form-field"><label>Experience</label><select id="experience"><option value="">Select Experience</option><option value="Fresher">Fresher (0-1 years)</option><option value="1-3 years">1-3 years</option><option value="3-5 years">3-5 years</option><option value="5-10 years">5-10 years</option><option value="10+ years">10+ years</option></select></div>
          <div class="form-field full-width"><label>Skills (comma separated)</label><input type="text" id="skills" placeholder="HTML, CSS, JavaScript"></div>
          <div class="form-field full-width"><label>Bio</label><textarea id="bio" placeholder="Tell us about yourself"></textarea></div>
        </div>
      </div>
      <div class="form-section">
        <h3 class="section-title">üìÖ Availability</h3>
        <div class="availability-toggle"><div class="toggle" id="availToggle"></div><span id="availLabel">Currently Unavailable</span></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Profile</button>
      </div>
    </form>
  </div>

  <div class="modal-backdrop" id="postModal">
    <div class="modal-content">
        <h3 class="hand-drawn">Create New Post/Service</h3>
        <form id="postForm">
            <div class="form-field">
                <label for="postTitle">Job/Service Title <span class="required">*</span></label>
                <input type="text" id="postTitle" required placeholder="e.g., Expert Electrician Needed">
            </div>
            <div class="form-field">
                <label for="postCategory">Category <span class="required">*</span></label>
                <select id="postCategory" required>
                    <option value="">Select Category</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Home Services">Home Services</option>
                    <option value="Tutoring">Tutoring</option>
                    <option value="Photography">Photography</option>
                    <option value="Repair">Repair</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-field">
                <label for="postPrice">Price / Quote (‚Çπ) <span class="required">*</span></label>
                <input type="number" id="postPrice" required min="100" placeholder="e.g., 500">
            </div>
            <div class="form-field">
                <label for="postDescription">Description <span class="required">*</span></label>
                <textarea id="postDescription" required placeholder="Describe the job or service you offer."></textarea>
            </div>
             <div class="form-field">
                <label for="postImage">Image (Optional)</label>
                <input type="file" id="postImage" accept="image/*">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePostModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="savePostBtn">Publish Post</button>
            </div>
        </form>
    </div>
  </div>
  
  <div class="modal-backdrop" id="applicantsModal">
    <div class="modal-content">
        <h3 class="hand-drawn">Applications for <span id="modalJobTitle"></span></h3>
        <div id="applicantsList">
            <p style="text-align: center; color: var(--muted);">Loading applications...</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeApplicantsModal()">Close</button>
        </div>
    </div>
  </div>
  <!-- Applicants Modal -->
  <div id="applicants-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
        <h2 id="modal-job-title" style="margin: 0; color: var(--primary);">Applications</h2>
        <button onclick="closeApplicantsModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text); line-height: 1;">&times;</button>
      </div>
      <div id="applicants-list">
        <p style="text-align: center; color: var(--muted); padding: 20px;">Loading applications...</p>
      </div>
    </div>
  </div>

    <!-- Hours Input Modal -->
  <div id="hours-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
        <h2 style="margin: 0; color: var(--primary);">Work Completed</h2>
        <button onclick="closeHoursModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text); line-height: 1;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="margin: 0 0 20px 0; color: var(--text-light); font-size: 14px;">
          Please enter the total hours worked to calculate the payment amount.
        </p>
        
        <label style="display: block; font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 14px;">
          Hours Worked *
        </label>
        <input 
          type="number" 
          id="hours-input" 
          placeholder="e.g., 8" 
          min="0.5" 
          step="0.5"
          style="width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 15px; font-family: inherit;"
          onkeypress="if(event.key === 'Enter') submitHours()"
        />
        <p style="margin: 8px 0 0 0; font-size: 12px; color: var(--muted);">
          You can enter decimal values (e.g., 7.5 hours)
        </p>
        
        <div id="amount-preview" style="display: none; margin-top: 20px; padding: 15px; background: rgba(156, 39, 176, 0.1); border-radius: var(--radius); border-left: 4px solid #7b1fa2;">
          <p style="margin: 0; color: #7b1fa2; font-weight: 600;">Payment Preview:</p>
          <p style="margin: 8px 0 0 0; font-size: 14px; color: #7b1fa2;">
            <span id="preview-hours">0</span> hours √ó ‚Çπ<span id="preview-rate">0</span>/hour = 
            <strong style="font-size: 18px;">‚Çπ<span id="preview-total">0</span></strong>
          </p>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="closeHoursModal()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
          Cancel
        </button>
        <button onclick="submitHours()" class="btn btn-primary" style="flex: 1; padding: 12px; background: #9c27b0;">
          Submit & Calculate
        </button>
      </div>
    </div>
  </div>
<!-- Rating & Feedback Modal -->
<div id="rating-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 500px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
      <h2 style="margin: 0; color: var(--primary);">Rate Your Experience</h2>
      <button onclick="closeRatingModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text); line-height: 1;">&times;</button>
    </div>
    
    <div id="rating-content">
      <h3 id="rating-job-title" style="color: var(--accent); margin-bottom: 20px;"></h3>
      
      <!-- Star Rating -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: 600; color: var(--text); margin-bottom: 10px;">
          Rate the Provider *
        </label>
        <div id="star-rating" style="font-size: 40px; cursor: pointer; user-select: none;">
          <span class="star" data-rating="1">‚òÜ</span>
          <span class="star" data-rating="2">‚òÜ</span>
          <span class="star" data-rating="3">‚òÜ</span>
          <span class="star" data-rating="4">‚òÜ</span>
          <span class="star" data-rating="5">‚òÜ</span>
        </div>
        <p id="rating-text" style="margin-top: 10px; color: var(--muted); font-size: 14px;">Click to rate</p>
      </div>
      
      <!-- Feedback Text -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: 600; color: var(--text); margin-bottom: 10px;">
          Write a Review (Optional)
        </label>
        <textarea 
          id="feedback-text" 
          placeholder="Share your experience with this provider..."
          style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 15px; resize: vertical;"
        ></textarea>
        <p style="margin-top: 5px; font-size: 12px; color: var(--muted);">
          Your review will be publicly visible on the provider's profile.
        </p>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button onclick="closeRatingModal()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
          Cancel
        </button>
        <button onclick="submitRating()" class="btn btn-primary" style="flex: 1; padding: 12px; background: #4CAF50;">
          Submit Review
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
   import { 
  getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc,query, where, orderBy, serverTimestamp,Timestamp }from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAOzsToiVP9BsevCDOjF54w341zIJghm_Y",
        authDomain: "walkin-3c91d.firebaseapp.com",
        projectId: "walkin-3c91d",
        storageBucket: "walkin-3c91d.appspot.com",
        messagingSenderId: "145040800467",
        appId: "1:145040800467:web:3075cc56710dd5eaef7226",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let isAvailable = false;
    let newImageFile = null;
    let newPostImageFile = null; 
    let existingProfileData = {}; 

    const form = document.getElementById('profileForm');
    const card = document.getElementById('profileCard');
    const activitySections = document.getElementById('activitySections');
    const successMsg = document.getElementById('successMessage');
    const imagePreview = document.getElementById('profileImagePreview');
    const imageUpload = document.getElementById('imageUpload');
    const availToggle = document.getElementById('availToggle');
    const availLabel = document.getElementById('availLabel');
    const subtitleText = document.getElementById('subtitleText');
    const cancelBtn = document.getElementById('cancelBtn');
    const createPostBtn = document.getElementById('createPostTabBtn'); 
    const postModal = document.getElementById('postModal');
    const postForm = document.getElementById('postForm');
    const postImageUpload = document.getElementById('postImage');
    const savePostBtn = document.getElementById('savePostBtn');
    const applicantsModal = document.getElementById('applicantsModal');
    const applicantsList = document.getElementById('applicantsList');
    const modalJobTitle = document.getElementById('modalJobTitle');
    
    window.openApplicantsModal = openApplicantsModal;
    window.closeApplicantsModal = closeApplicantsModal;
    window.closePostModal = closePostModal;
    window.updateApplicationStatus = updateApplicationStatus;

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUser = user;
            loadProfileData(user);
        } else {
            alert("Please log in to view your profile.");
            window.location.href = 'home.html';
        }
    });

    async function loadProfileData(user) {
        const profileRef = doc(db, "profiles", user.uid);
        const profileSnap = await getDoc(profileRef);

        if (profileSnap.exists()) {
            existingProfileData = profileSnap.data();
            renderProfileCard(existingProfileData);
            setFormFromData(existingProfileData);
            showCardView();
            loadActivityData(); 
        } else {
            existingProfileData = {}; 
            subtitleText.textContent = "Welcome! Let's create your profile.";
            setFormFromData({ username: user.displayName || '', email: user.email || '' });
            showFormView();
        }
    }

    function loadActivityData(tab = 'posts') {
        switch (tab) {
            case 'posts':
                loadUserPosts();
                break;
            case 'applied':
                loadUserApplications();
                break;
            case 'completed':
                loadCompletedJobs();
                break;
        }
    }
    
    async function loadUserPosts() {
        const postsList = document.getElementById('postsList');
        postsList.innerHTML = '<p style="text-align: center; color: var(--muted-light);">Loading posts...</p>';
        try {
            const postsQuery = query(
                collection(db, 'jobs'),
                where('providerUid', '==', currentUser.uid),
                orderBy('createdAt', 'desc')
            );
            const postsSnap = await getDocs(postsQuery);
            
            if (postsSnap.empty) {
                 postsList.innerHTML = '<p style="text-align: center; color: var(--muted);">No posts published yet. Click the + button to create your first one!</p>';
                 return;
            }

            postsList.innerHTML = '';
            
            const applicationsQuery = query(
                collection(db, 'applications'),
                where('providerUid', '==', currentUser.uid)
            );
            const applicationsSnap = await getDocs(applicationsQuery);
            const applicationCounts = {};
            
            applicationsSnap.forEach(doc => {
                const app = doc.data();
                applicationCounts[app.jobId] = (applicationCounts[app.jobId] || 0) + 1;
            });
            
            postsSnap.forEach(docSnap => {
                const job = docSnap.data();
                const jobId = docSnap.id;
                const appCount = applicationCounts[jobId] || 0;
                
                const postItem = document.createElement('div');
                postItem.className = 'profile-job-post';
                postItem.style.cssText = 'border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; border-radius: var(--radius); background: var(--surface); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;';
                postItem.innerHTML = `
  <div>
    <h4 style="color:var(--accent);margin:0">${job.title}</h4>
    <p style="font-size:13px;color:var(--text-light);margin:5px 0 0">Category: ${job.category} ‚Ä¢ Price: ‚Çπ${job.price}</p>
    <p style="font-size:12px;color:var(--muted);margin:2px 0 0">Status: ${job.status} ‚Ä¢ Applications: ${appCount}</p>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn btn-secondary" 
      onclick="openApplicantsModal('${jobId}', '${job.title.replace(/'/g, "\\'")}', ${appCount})" 
      style="padding:8px 16px">
      View Applications (${appCount})
    </button>
    <button class="btn ${appCount > 0 ? 'btn-danger' : 'btn-secondary'}" 
      onclick="deleteJob('${jobId}')" 
      style="padding:8px 16px; ${appCount > 0 ? 'background:#f44336;color:white;' : ''}">
      ${appCount > 0 ? '‚ö†Ô∏è Delete (' + appCount + ')' : 'üóëÔ∏è Delete'}
    </button>
  </div>
`;

                postsList.appendChild(postItem);
                
            });

        } catch (error) {
            console.error("Error loading user posts:", error);
            postsList.innerHTML = '<p style="text-align: center; color: red;">Error loading your posts. Please refresh the page.</p>';
        }
    }
// ============================================
// LOAD USER APPLICATIONS (APPLICANT VIEW) - IMPROVED DESIGN
// ============================================
async function loadUserApplications() {
  const appliedList = document.getElementById('appliedList');
  appliedList.innerHTML = '<p style="color: var(--muted)">Loading...</p>';

  try {
    const q = query(
      collection(db, 'applications'),
      where('applicantUid', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      appliedList.innerHTML = '<p style="color: var(--muted)">You haven\'t applied to any jobs yet.</p>';
      return;
    }

    appliedList.innerHTML = '';
    
    querySnapshot.forEach(appDoc => {
      const app = appDoc.data();
      const appId = appDoc.id;
      
      const appDate = app.createdAt?.toDate?.() 
        ? new Date(app.createdAt.toDate()).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })
        : 'Recently';
      
      const status = app.status || 'pending';
      
      const card = document.createElement('div');
      card.className = 'job-card';
      
      // UNIFIED CARD HTML - Everything in one box
      let cardHTML = `
        <!-- Header Section -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
          <div>
            <h3 style="color: var(--primary); margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">${app.jobTitle}</h3>
            <p style="font-size: 13px; color: var(--muted); margin: 0;">üìÖ Applied on ${appDate}</p>
          </div>
          <span class="status-badge status-${status}">${status}</span>
        </div>
        
        <!-- Status Content Section -->
      `;
      
      // Status-specific content (inside the same card)
      if (status === 'pending') {
        cardHTML += `
          <div style="padding: 10px; background: rgba(255, 193, 7, 0.08); border-left: 3px solid #f57c00; border-radius: 4px;">
            <p style="margin: 0; color: var(--text); font-size: 14px;">‚è≥ Your application is under review</p>
          </div>
        `;
      } 
      else if (status === 'accepted') {
        cardHTML += `
          <div style="padding: 10px; background: rgba(76, 175, 80, 0.08); border-left: 3px solid #2e7d32; border-radius: 4px;">
            <p style="margin: 0 0 4px 0; color: #2e7d32; font-weight: 600; font-size: 14px;">‚úÖ Application Accepted!</p>
            <p style="margin: 0; color: var(--text-light); font-size: 13px;">Waiting for the provider to start the work.</p>
          </div>
        `;
      }
      else if (status === 'rejected') {
        cardHTML += `
          <div style="padding: 10px; background: rgba(244, 67, 54, 0.08); border-left: 3px solid #c62828; border-radius: 4px;">
            <p style="margin: 0 0 4px 0; color: #c62828; font-weight: 600; font-size: 14px;">üòî Application Rejected</p>
            ${app.rejectionReason ? `
              <p style="margin: 0; color: var(--text-light); font-size: 13px;"><strong>Reason:</strong> ${app.rejectionReason}</p>
            ` : ''}
          </div>
        `;
      }
else if (status === 'in-progress') {
  const startDate = app.workStartDate?.toDate?.() 
    ? new Date(app.workStartDate.toDate()).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })
    : 'Recently';
  
  cardHTML += `
    <div style="padding: 12px; background: rgba(33, 150, 243, 0.08); border-left: 3px solid #1976d2; border-radius: 4px;">
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; color: #1976d2; font-weight: 600; font-size: 14px;">üîß Work In Progress</p>
        <p style="margin: 0; color: var(--text-light); font-size: 13px;">Started on ${startDate}</p>
      </div>
      
      <div style="padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 6px; border: 1px dashed #1976d2;">
        <p style="margin: 0 0 10px 0; font-size: 13px; color: var(--text-light);">
          Is the work completed to your satisfaction?
        </p>
        <button 
          onclick="confirmWorkDone('${appId}')" 
          class="btn btn-primary" 
          style="width: 100%; padding: 10px; background: #1976d2; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
          ‚úÖ Confirm Work Completed
        </button>
      </div>
    </div>
  `;
}

     else if (status === 'awaiting-payment') {
  const completedDate = app.workEndDate?.toDate?.() 
    ? new Date(app.workEndDate.toDate()).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })
    : 'Recently';
  
  cardHTML += `
    <div style="padding: 12px; background: rgba(156, 39, 176, 0.08); border-left: 3px solid #7b1fa2; border-radius: 4px;">
      <div style="margin-bottom: 12px;">
        <p style="margin: 0 0 4px 0; color: #7b1fa2; font-weight: 600; font-size: 14px;">üí≥ Payment Required</p>
        <p style="margin: 0; color: var(--text-light); font-size: 13px;">Work completed on ${completedDate}</p>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 6px; border: 1px solid rgba(156, 39, 176, 0.2); margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="color: var(--text-light); font-size: 13px;">Hours Worked:</span>
          <span style="color: var(--text); font-weight: 600; font-size: 14px;">${app.totalHours || 0} hours</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 6px; border-top: 1px solid var(--border-light);">
          <span style="color: #7b1fa2; font-weight: 600; font-size: 14px;">Total Amount:</span>
          <span style="color: #7b1fa2; font-weight: 700; font-size: 18px;">‚Çπ${app.totalAmount || 0}</span>
        </div>
      </div>
      
      <button 
        onclick="alert('Payment integration coming in next step! üöÄ')" 
        class="btn btn-primary" 
        style="width: 100%; padding: 12px; background: #7b1fa2; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 15px;">
        üí≥ Pay Now - ‚Çπ${app.totalAmount || 0}
      </button>
    </div>
  `;
}

      else if (status === 'completed') {
        const completedDate = app.completedAt?.toDate?.() 
          ? new Date(app.completedAt.toDate()).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })
          : 'Recently';
        
        cardHTML += `
          <div style="padding: 10px; background: rgba(76, 175, 80, 0.08); border-left: 3px solid #2e7d32; border-radius: 4px;">
            <p style="margin: 0 0 8px 0; color: #2e7d32; font-weight: 600; font-size: 14px;">‚úÖ Completed</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: var(--text-light); font-size: 13px;">Paid: ‚Çπ${app.totalAmount || 0}</span>
              <span style="color: var(--text-light); font-size: 13px;">${completedDate}</span>
            </div>
          </div>
        `;
      }
      
      card.innerHTML = cardHTML;
      appliedList.appendChild(card);
    });
  } catch (error) {
    console.error('Error loading applications:', error);
    appliedList.innerHTML = '<p style="color: red">Error loading applications.</p>';
  }
}

// ============================================
// CONFIRM WORK DONE (APPLICANT SIDE)
// ============================================

async function confirmWorkDone(applicationId) {
  if (!confirm('Confirm that the work has been completed to your satisfaction?\n\nAfter confirmation, you will need to make the payment.')) {
    return;
  }
  
  try {
    // Note: We're NOT changing the status here
    // The provider already set it to 'awaiting-payment' when they marked work completed
    // This is just applicant acknowledgment
    
    const appRef = doc(db, 'applications', applicationId);
    const appSnap = await getDoc(appRef);
    
    if (!appSnap.exists()) {
      alert('Application not found.');
      return;
    }
    
    const app = appSnap.data();
    
    // Check if provider has already marked it as completed
    if (app.status === 'awaiting-payment') {
      alert('‚úÖ Work already confirmed!\n\nPlease proceed with payment.');
      loadUserApplications(); // Refresh to show payment option
      return;
    }
    
    // If still in-progress, show message
    alert('‚è≥ Waiting for provider to mark work as completed.\n\nThe provider needs to enter the hours worked before you can proceed to payment.');
    
  } catch (error) {
    console.error('Error confirming work:', error);
    alert(`Failed to confirm: ${error.message}`);
  }
}
// ============================================
// LOAD COMPLETED JOBS (BOTH PROVIDER & APPLICANT)
// ============================================

async function loadCompletedJobs() {
  const completedList = document.getElementById('completedList');
  completedList.innerHTML = '<p style="color: var(--muted)">Loading...</p>';

  try {
    // Query for jobs where user is the provider
    const providerQuery = query(
      collection(db, 'applications'),
      where('providerUid', '==', currentUser.uid),
      where('status', '==', 'completed'),
      orderBy('completedAt', 'desc')
    );
    
    // Query for jobs where user is the applicant/client
    const applicantQuery = query(
      collection(db, 'applications'),
      where('applicantUid', '==', currentUser.uid),
      where('status', '==', 'completed'),
      orderBy('completedAt', 'desc')
    );
    
    // Execute both queries in parallel
    const [providerSnapshot, applicantSnapshot] = await Promise.all([
      getDocs(providerQuery),
      getDocs(applicantQuery)
    ]);
    
    // Check if any completed jobs exist
    if (providerSnapshot.empty && applicantSnapshot.empty) {
      completedList.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <p style="font-size: 48px; margin: 0;">üìã</p>
          <p style="color: var(--muted); margin: 10px 0 0 0; font-size: 15px;">No completed jobs yet.</p>
        </div>
      `;
      return;
    }

    completedList.innerHTML = '';
    
    // Display Provider Jobs (jobs you provided service for)
    if (!providerSnapshot.empty) {
      const providerSection = document.createElement('div');
      providerSection.innerHTML = `
        <h3 style="color: var(--primary); margin: 0 0 15px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
          <span>üë®‚Äçüíº</span> As Service Provider
        </h3>
      `;
      completedList.appendChild(providerSection);
      
providerSnapshot.forEach(docSnap => {
  const app = { ...docSnap.data(), id: docSnap.id }; // Add document ID
  const card = createCompletedJobCard(app, 'provider');
  completedList.appendChild(card);
});

    }
    
    // Display Applicant Jobs (jobs you hired someone for)
    if (!applicantSnapshot.empty) {
      const applicantSection = document.createElement('div');
      applicantSection.style.marginTop = providerSnapshot.empty ? '0' : '30px';
      applicantSection.innerHTML = `
        <h3 style="color: var(--primary); margin: 0 0 15px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
          <span>üë§</span> As Client
        </h3>
      `;
      completedList.appendChild(applicantSection);
      
applicantSnapshot.forEach(docSnap => {
  const app = { ...docSnap.data(), id: docSnap.id }; // Add document ID
  const card = createCompletedJobCard(app, 'applicant');
  completedList.appendChild(card);
});

    }
    
  } catch (error) {
    console.error('Error loading completed jobs:', error);
    completedList.innerHTML = `
      <p style="color: #f44336; text-align: center;">
        Error loading completed jobs: ${error.message}
      </p>
    `;
  }
}

// Create completed job card
function createCompletedJobCard(app, role) {
  const completedDate = app.completedAt?.toDate?.() 
    ? new Date(app.completedAt.toDate()).toLocaleDateString('en-IN', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      })
    : 'Recently';
  
  const card = document.createElement('div');
  card.className = 'job-card';
  card.style.borderLeft = '4px solid #2e7d32';
  card.style.background = 'linear-gradient(to right, rgba(76, 175, 80, 0.02), var(--surface))';
  
  card.innerHTML = `
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
      <div>
        <h3 style="color: var(--primary); margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">
          ${app.jobTitle || 'Job'}
        </h3>
        <p style="font-size: 13px; color: var(--muted); margin: 0;">
          ‚úÖ Completed on ${completedDate}
        </p>
      </div>
      <span class="status-badge status-completed">completed</span>
    </div>
    
    <!-- Job Details -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
      <div style="padding: 10px; background: rgba(76, 175, 80, 0.05); border-radius: 6px; border: 1px solid rgba(76, 175, 80, 0.2);">
        <p style="margin: 0 0 4px 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Hours Worked
        </p>
        <p style="margin: 0; font-size: 18px; font-weight: 700; color: #2e7d32;">
          ${app.totalHours || 0}h
        </p>
      </div>
      
      <div style="padding: 10px; background: rgba(76, 175, 80, 0.05); border-radius: 6px; border: 1px solid rgba(76, 175, 80, 0.2);">
        <p style="margin: 0 0 4px 0; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Amount ${role === 'provider' ? 'Earned' : 'Paid'}
        </p>
        <p style="margin: 0; font-size: 18px; font-weight: 700; color: #2e7d32;">
          ‚Çπ${app.totalAmount || 0}
        </p>
      </div>
    </div>
    
    <!-- Payment Info -->
    <div style="padding: 8px 12px; background: rgba(76, 175, 80, 0.05); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
      <span style="font-size: 13px; color: var(--text-light);">
        ${role === 'provider' ? 'üí∞ Payment Received' : '‚úÖ Payment Completed'}
      </span>
      <span style="font-size: 12px; color: var(--muted);">
        ${app.paymentId ? `ID: ${app.paymentId.substring(0, 12)}...` : 'Cash Payment'}
      </span>
    </div>
    
   <!-- Rating & Feedback Section -->
${role === 'applicant' && !app.providerRating ? `
  <button 
    onclick="openRatingModal('${app.id}', '${app.jobTitle}')" 
    class="btn btn-primary" 
    style="width: 100%; margin-top: 15px; padding: 10px; background: #ffc107; color: #000; font-weight: 600;">
    ‚≠ê Rate Provider
  </button>
` : ''}

${app.providerRating ? `
  <div style="margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px; border-left: 4px solid #4CAF50;">
    <p style="margin: 0 0 8px 0; color: #2e7d32; font-weight: 600; font-size: 14px;">
      Your Rating: ${'‚≠ê'.repeat(app.providerRating)} (${app.providerRating}/5)
    </p>
    ${app.providerFeedback ? `
      <p style="margin: 0; font-size: 13px; color: var(--text-light); font-style: italic; line-height: 1.5;">
        "${app.providerFeedback}"
      </p>
    ` : ''}
  </div>
` : ''}

  `;
  
  return card;
}

// Make globally accessible
window.confirmWorkDone = confirmWorkDone;

// Update your switchTab function or create it if it doesn't exist
window.switchTab = function(tabName) {
  // Remove active class from all tabs and content
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  // Add active class to clicked tab
  document.getElementById('tab-' + tabName).classList.add('active');
  document.getElementById(tabName + 'List').classList.add('active');
  
  // Load data for specific tabs
  if (tabName === 'applied') {
    loadUserApplications();
  }
  if (tabName === 'completed') {
    loadCompletedJobs();
  }
};


    
    // function loadCompletedJobs() {
    //     document.getElementById('completedList').innerHTML = '<p style="text-align: center; color: var(--muted);">No completed jobs found. Great work awaits!</p>';
    // }

    function renderProfileCard(data) {
        isAvailable = !!data.isAvailable;
        const initial = (data.username || 'U').charAt(0).toUpperCase();

        card.innerHTML = `
            <div class="card-header">
                <div class="card-profile-image">
                    ${data.profileImageURL ? `<img src="${data.profileImageURL}" alt="Profile">` : `<span>${initial}</span>`}
                </div>
                <h2 class="card-name">${data.username || 'User Name'}</h2>
                <p class="card-title">${data.occupation || 'Professional'}</p>
                <div class="availability-badge ${isAvailable ? 'available' : 'unavailable'}">
                    <span>‚óè</span>
                    <span>${isAvailable ? 'Available' : 'Unavailable'}</span>
                </div>
            </div>
            <div class="card-content">
                <div class="card-section"><h3>üìû Contact</h3><div class="info-item"><div class="info-label">Email</div><div>${data.email || '-'}</div></div><div class="info-item"><div class="info-label">Phone</div><div>${data.phone || 'Not provided'}</div></div></div>
                <div class="card-section"><h3>üíº Professional</h3><div class="info-item"><div class="info-label">Experience</div><div>${data.experience || 'Not specified'}</div></div><div class="info-item"><div class="info-label">Education</div><div>${data.education || 'Not specified'}</div></div></div>
                <div class="card-section full-width"><h3>üìù About</h3><p>${data.bio || 'No bio provided'}</p></div>
                <div class="card-section full-width"><h3>üîß Skills</h3><div class="skills-list">${(data.skills || '').split(',').map(s => s.trim()).filter(Boolean).map(skill => `<span class="skill-tag">${skill}</span>`).join('') || '<span class="skill-tag">No skills listed</span>'}</div></div>
            </div>
            <div class="card-actions"><button class="btn btn-edit" id="editProfileBtn">‚úèÔ∏è Edit Profile</button></div>
        `;
        document.getElementById('editProfileBtn').addEventListener('click', showFormView);
    }
    
    function setFormFromData(data) {
        isAvailable = !!data.isAvailable;
        document.getElementById('username').value = data.username || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('phone').value = data.phone && data.phone !== 'Not provided' ? data.phone : '';
        document.getElementById('education').value = data.education && data.education !== 'Not specified' ? data.education : '';
        document.getElementById('occupation').value = data.occupation && data.occupation !== 'Professional' ? data.occupation : '';
        document.getElementById('experience').value = data.experience && data.experience !== 'Not specified' ? data.experience : '';
        document.getElementById('skills').value = data.skills || '';
        document.getElementById('bio').value = data.bio && data.bio !== 'No bio provided' ? data.bio : '';
        availToggle.classList.toggle('active', isAvailable);
        availLabel.textContent = isAvailable ? 'Currently Available' : 'Currently Unavailable';
        const initial = (data.username || 'U').charAt(0).toUpperCase();
        imagePreview.innerHTML = data.profileImageURL ? `<img src="${data.profileImageURL}" alt="Profile">` : `<span>${initial}</span>`;
    }

    form.onsubmit = async (e) => {
        e.preventDefault();
        if (!currentUser) return alert("You must be logged in to save your profile.");

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        
        const profileData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value || 'Not provided',
            education: document.getElementById('education').value || 'Not specified',
            occupation: document.getElementById('occupation').value || 'Professional',
            experience: document.getElementById('experience').value || 'Not specified',
            skills: document.getElementById('skills').value,
            bio: document.getElementById('bio').value || 'No bio provided',
            isAvailable,
            updatedAt: serverTimestamp(),
            profileImageURL: existingProfileData.profileImageURL || null 
        };

        try {
            if (newImageFile) {
                submitBtn.textContent = 'Uploading image...';
                const newImageURL = await uploadImageViaCustomServer(newImageFile, currentUser.uid, 'api/upload-profile-image');
                profileData.profileImageURL = newImageURL;
            }

            if (!existingProfileData.createdAt) {
                profileData.createdAt = serverTimestamp();
            }

            submitBtn.textContent = 'Saving...';
            const profileRef = doc(db, "profiles", currentUser.uid);
            await setDoc(profileRef, profileData, { merge: true });

            existingProfileData = profileData; 
            await loadProfileData(currentUser); 

            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);

        } catch (error) {
            console.error("Error saving profile:", error);
            alert(`Failed to save profile. Error: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Profile';
            newImageFile = null; 
        }
    };
    
    async function uploadImageViaCustomServer(file, uid, endpoint) {
        const uploadUrl = `http://localhost:3000/${endpoint}`; 
        const formData = new FormData();
        formData.append('profileImage', file); 
        formData.append('userId', uid); 

        try {
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData, 
            });

            if (!response.ok) {
                const errorData = await response.json(); 
                throw new Error(errorData.message || `Server responded with status ${response.status}`);
            }

            const data = await response.json();
            return data.url; 
            
        } catch (error) {
            if (error.message.includes('fetch failed')) {
                throw new Error(`Connection failed. Is your Node.js server running at http://localhost:3000?`);
            }
            throw new Error(`Upload failed: ${error.message}`);
        }
    }

    function openPostModal() {
        postModal.style.display = 'flex';
        postForm.reset();
        newPostImageFile = null;
    }

    function closePostModal() {
        postModal.style.display = 'none';
    }
    
 async function openApplicantsModal(jobId, jobTitle, count) {
  if (count === 0) {
    alert("No applications yet for this job.");
    return;
  }
  
  const applicantsModal = document.getElementById('applicants-modal');
  const modalJobTitle = document.getElementById('modal-job-title');
  const applicantsList = document.getElementById('applicants-list');
  
  modalJobTitle.textContent = `Applications for: ${jobTitle}`;
  applicantsModal.style.display = 'flex';
  applicantsList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">Loading applications...</p>';
  
  try {
    const applicationsQuery = query(
      collection(db, 'applications'),
      where('jobId', '==', jobId),
      orderBy('createdAt', 'desc')
    );
    
    const applicationsSnap = await getDocs(applicationsQuery);
    
    if (applicationsSnap.empty) {
      applicantsList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">No applications found.</p>';
      return;
    }
    
    applicantsList.innerHTML = '';
    
    applicationsSnap.forEach(docSnap => {
      const app = docSnap.data();
      const appId = docSnap.id;
      
      let appDate = 'Recently';
      if (app.createdAt?.toDate) {
        appDate = new Date(app.createdAt.toDate()).toLocaleDateString('en-IN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } else if (app.createdAt?.seconds) {
        appDate = new Date(app.createdAt.seconds * 1000).toLocaleDateString('en-IN', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
      
      const applicantItem = document.createElement('div');
      applicantItem.className = 'applicant-item';
      
      // Get status (default to pending if not set)
      const status = app.status || 'pending';
      
      applicantItem.innerHTML = `
        <div class="applicant-header">
          <div class="applicant-info">
            <h4>${app.applicantName || 'N/A'}</h4>
            <p><strong>Email:</strong> ${app.applicantEmail || 'N/A'}</p>
            <p><strong>Phone:</strong> ${app.applicantPhone || 'Not provided'}</p>
            ${app.applicantMessage && app.applicantMessage.trim() !== '' && app.applicantMessage !== 'No message provided' 
              ? `<p style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-light); font-size: 13px; color: var(--text); line-height: 1.5;"><strong>Message:</strong><br>${app.applicantMessage}</p>` 
              : ''}
            <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">üìÖ Applied on ${appDate}</p>
          </div>
          <span class="status-badge status-${status}">${status}</span>
        </div>
        
        ${status === 'pending' ? `
          <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light);">
            <button class="btn btn-edit" 
              onclick="updateApplicationStatus('${appId}', 'accepted')" 
              style="flex: 1; padding: 10px 20px; font-size: 14px; background: #4caf50; color: white; border: none;">
              ‚úì Accept
            </button>
            <button class="btn btn-secondary" 
              onclick="updateApplicationStatus('${appId}', 'rejected')" 
              style="flex: 1; padding: 10px 20px; font-size: 14px; background: #f44336; color: white; border: none;">
              ‚úó Reject
            </button>
          </div>
        ` : ''}
        
        ${status === 'rejected' && app.rejectionReason ? `
          <div class="rejection-box">
            <p style="margin: 0 0 5px 0; font-weight: 600;">üòî Rejected</p>
            <p style="margin: 0; font-size: 13px; font-weight: normal;">Reason: ${app.rejectionReason}</p>
          </div>
        ` : status === 'rejected' ? `
          <div class="rejection-box">
            <p style="margin: 0;">üòî Rejected</p>
          </div>
        ` : ''}
        
        ${status === 'accepted' ? `
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light);">
    <div style="padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; margin-bottom: 10px;">
      <p style="margin: 0; color: #2e7d32; font-weight: 600;">‚úÖ Accepted - Ready to start work</p>
    </div>
    <button class="btn btn-edit" 
      onclick="markJobInProgress('${appId}')" 
      style="width: 100%; padding: 12px 20px; font-size: 14px; background: #2196f3; color: white; border: none;">
      üöÄ Mark as In Progress
    </button>
  </div>
` : ''}

${status === 'in-progress' ? `
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light);">
    <div style="padding: 12px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 4px solid #1976d2; margin-bottom: 10px;">
      <p style="margin: 0; color: #1976d2; font-weight: 600;">üîß Work In Progress</p>
      <p style="margin: 5px 0 0 0; font-size: 13px; color: #1976d2;">
        Started: ${app.workStartDate ? new Date(app.workStartDate.toDate()).toLocaleDateString('en-IN') : 'Recently'}
      </p>
    </div>
    <button class="btn btn-edit" 
      onclick="markWorkCompleted('${appId}')" 
      style="width: 100%; padding: 12px 20px; font-size: 14px; background: #9c27b0; color: white; border: none;">
      ‚úÖ Mark Work Completed
    </button>
  </div>
` : ''}
${status === 'awaiting-payment' ? `
  <div style="margin-top: 15px; padding: 15px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; border-left: 4px solid #7b1fa2;">
    <p style="margin: 0; color: #7b1fa2; font-weight: 600;">üí≥ Awaiting Payment</p>
    <p style="margin: 8px 0 0 0; font-size: 14px; color: #7b1fa2;">
      <strong>Total Amount:</strong> ‚Çπ${app.totalAmount || 0}
    </p>
    <p style="margin: 4px 0 0 0; font-size: 13px; color: #7b1fa2;">
      Hours worked: ${app.totalHours || 0} hours
    </p>
    <p style="margin: 4px 0 0 0; font-size: 12px; color: #7b1fa2;">
      Completed: ${app.workEndDate ? new Date(app.workEndDate.toDate()).toLocaleDateString('en-IN') : 'Recently'}
    </p>
  </div>
` : ''}


      `;
      
      applicantsList.appendChild(applicantItem);
    });
  } catch (error) {
    console.error("Error loading applicants:", error);
    applicantsList.innerHTML = `<p style="text-align: center; color: #f44336; padding: 20px;">Error loading applications: ${error.message}</p>`;
  }
}

// Make globally accessible
window.openApplicantsModal = openApplicantsModal;

// Close Applicants Modal
function closeApplicantsModal() {
  const modal = document.getElementById('applicants-modal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Make globally accessible
window.closeApplicantsModal = closeApplicantsModal;

    
   // ============================================
// ENHANCED ACCEPT/REJECT WITH REASON
// ============================================

// Update Application Status - Enhanced with rejection reason
async function updateApplicationStatus(applicationId, newStatus) {
  let rejectionReason = '';
  
  // If rejecting, ask for optional reason
  if (newStatus === 'rejected') {
    rejectionReason = prompt('Optional: Enter reason for rejection');
    if (rejectionReason === null) return; // User cancelled
  } else {
    // Confirm accept
    if (!confirm(`Are you sure you want to ACCEPT this application?`)) {
      return;
    }
  }
  
  try {
    const appRef = doc(db, 'applications', applicationId);
    const updateData = {
      status: newStatus,
      updatedAt: serverTimestamp()
    };
    
    // Add rejection reason if provided
    if (newStatus === 'rejected' && rejectionReason) {
      updateData.rejectionReason = rejectionReason.trim();
    }
    
    await updateDoc(appRef, updateData);
    
    const message = newStatus === 'accepted' 
      ? 'Application accepted successfully! ‚úì' 
      : 'Application rejected.';
    
    alert(message);
    closeApplicantsModal();
    loadUserPosts(); // Refresh the posts list
  } catch (error) {
    console.error("Error updating application:", error);
    alert(`Failed to update application: ${error.message}`);
  }
}

// Make globally accessible
window.updateApplicationStatus = updateApplicationStatus;

// ============================================
// MARK JOB AS IN-PROGRESS
// ============================================

async function markJobInProgress(applicationId) {
  if (!confirm('Confirm that work has started?')) {
    return;
  }
  
  try {
    const appRef = doc(db, 'applications', applicationId);
    await updateDoc(appRef, {
      status: 'in-progress',
      workStartDate: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    alert('Job marked as in-progress! üöÄ');
    closeApplicantsModal();
    loadUserPosts(); // Refresh the posts list
  } catch (error) {
    console.error('Error marking job as in-progress:', error);
    alert(`Failed to update status: ${error.message}`);
  }
}

// Make globally accessible
window.markJobInProgress = markJobInProgress;

// ============================================
// MARK WORK COMPLETED (Calculate Amount)
// ============================================
// ============================================
// MARK WORK COMPLETED - WITH CUSTOM MODAL
// ============================================

// Store current application ID for the modal
let currentApplicationId = null;
let currentHourlyRate = 0;

// Open hours input modal
async function markWorkCompleted(applicationId) {
  try {
    // Get application data
    const appRef = doc(db, 'applications', applicationId);
    const appSnap = await getDoc(appRef);
    
    if (!appSnap.exists()) {
      alert('Application not found.');
      return;
    }
    
    
    const app = appSnap.data();
    
    // Get job data to get the hourly rate
    const jobRef = doc(db, 'jobs', app.jobId);
    const jobSnap = await getDoc(jobRef);
    
    if (!jobSnap.exists()) {
      alert('Job not found.');
      return;
    }
    
    const job = jobSnap.data();
    
    // Store data for later use
    currentApplicationId = applicationId;
    currentHourlyRate = parseFloat(job.price || 0);
    
    // Update preview rate
    document.getElementById('preview-rate').textContent = currentHourlyRate;
    
    // Open the modal
    document.getElementById('hours-modal').style.display = 'flex';
    document.getElementById('hours-input').value = '';
    document.getElementById('hours-input').focus();
    document.getElementById('amount-preview').style.display = 'none';
    
  } catch (error) {
    console.error('Error:', error);
    alert(`Failed to open hours input: ${error.message}`);
  }
}

// Close hours modal
function closeHoursModal() {
  document.getElementById('hours-modal').style.display = 'none';
  currentApplicationId = null;
  currentHourlyRate = 0;
}

// Live preview of amount as user types
document.addEventListener('DOMContentLoaded', function() {
  const hoursInput = document.getElementById('hours-input');
  if (hoursInput) {
    hoursInput.addEventListener('input', function() {
      const hours = parseFloat(this.value);
      if (!isNaN(hours) && hours > 0) {
        const total = hours * currentHourlyRate;
        document.getElementById('preview-hours').textContent = hours;
        document.getElementById('preview-total').textContent = total.toFixed(2);
        document.getElementById('amount-preview').style.display = 'block';
      } else {
        document.getElementById('amount-preview').style.display = 'none';
      }
    });
  }
});

// Submit hours and calculate amount
async function submitHours() {
  const hours = document.getElementById('hours-input').value;
  
  // Validate input
  if (!hours || hours.trim() === '') {
    alert('Please enter the hours worked.');
    document.getElementById('hours-input').focus();
    return;
  }
  
  const hoursNum = parseFloat(hours);
  
  if (isNaN(hoursNum) || hoursNum <= 0) {
    alert('Please enter a valid positive number for hours.');
    document.getElementById('hours-input').focus();
    return;
  }
  
  if (hoursNum > 100) {
    if (!confirm('You entered ' + hoursNum + ' hours. Is this correct?')) {
      return;
    }
  }
  
  try {
    const totalAmount = hoursNum * currentHourlyRate;
    
    // Update application in Firestore
    const appRef = doc(db, 'applications', currentApplicationId);
    await updateDoc(appRef, {
      status: 'awaiting-payment',
      workEndDate: serverTimestamp(),
      totalHours: hoursNum,
      totalAmount: totalAmount,
      paymentStatus: 'pending',
      updatedAt: serverTimestamp()
    });
    
    // Close modals
    closeHoursModal();
    closeApplicantsModal();
    
    // Show success message
    alert(`‚úÖ Work Completed Successfully!\n\nHours: ${hoursNum}\nRate: ‚Çπ${currentHourlyRate}/hour\nTotal Amount: ‚Çπ${totalAmount.toFixed(2)}\n\nStatus changed to "Awaiting Payment"`);
    
    // Refresh the posts list
    loadUserPosts();
    
  } catch (error) {
    console.error('Error updating application:', error);
    alert(`Failed to mark as completed: ${error.message}`);
  }
}

// Make functions globally accessible
window.markWorkCompleted = markWorkCompleted;
window.closeHoursModal = closeHoursModal;
window.submitHours = submitHours;


// Make globally accessible
window.markWorkCompleted = markWorkCompleted;


    postForm.onsubmit = async (e) => {
        e.preventDefault();
        if (!currentUser) return alert("You must be logged in to create a post.");

        savePostBtn.disabled = true;
        savePostBtn.textContent = 'Processing...';

        const postData = {
            title: document.getElementById('postTitle').value,
            category: document.getElementById('postCategory').value,
            price: parseInt(document.getElementById('postPrice').value, 10),
            description: document.getElementById('postDescription').value,
            providerUid: currentUser.uid,
            providerName: existingProfileData.username || currentUser.displayName || 'Anonymous',
            providerOccupation: existingProfileData.occupation || 'Professional',
            status: 'open',
            createdAt: serverTimestamp(),
            imageUrl: null
        };
        
        try {
            if (newPostImageFile) {
                savePostBtn.textContent = 'Uploading image...';
                const newImageURL = await uploadImageViaCustomServer(newPostImageFile, `${currentUser.uid}-post`, 'api/upload-profile-image');
                postData.imageUrl = newImageURL;
            }
            
            savePostBtn.textContent = 'Publishing...';
            await addDoc(collection(db, "jobs"), postData);

            alert("‚úÖ Post published successfully! Check the Explore page.");
            closePostModal();
            loadUserPosts();

        } catch (error) {
            console.error("Error creating post:", error);
            alert(`Failed to publish post. Error: ${error.message}`);
        } finally {
            savePostBtn.disabled = false;
            savePostBtn.textContent = 'Publish Post';
            newPostImageFile = null;
        }
    };
    
    postImageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            newPostImageFile = file;
        } else {
            newPostImageFile = null;
        }
    });

    function showFormView() {
        subtitleText.textContent = "Edit your profile details below.";
        card.classList.remove('show');
        activitySections.classList.add('hidden');
        form.classList.remove('hidden');
    }

    function showCardView() {
        subtitleText.textContent = "Manage your profile and professional activity.";
        form.classList.add('hidden');
        card.classList.add('show');
        activitySections.classList.remove('hidden');
    }

    cancelBtn.addEventListener('click', () => {
        if (Object.keys(existingProfileData).length > 0) {
            showCardView();
        } else {
            if (confirm('Are you sure you want to cancel profile creation?')) {
                window.location.href = 'home.html';
            }
        }
    });
    
    imagePreview.addEventListener('click', () => imageUpload.click());
    imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            newImageFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                imagePreview.innerHTML = `<img src="${ev.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    availToggle.addEventListener('click', () => {
        isAvailable = !isAvailable;
        availToggle.classList.toggle('active', isAvailable);
        availLabel.textContent = isAvailable ? 'Currently Available' : 'Currently Unavailable';
    });
    
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');

            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-${targetTab}`).classList.remove('hidden');

            loadActivityData(targetTab);
        });
    });

    createPostBtn.addEventListener('click', openPostModal);

    postModal.addEventListener('click', (e) => {
        if (e.target === postModal) {
            closePostModal();
        }
    });
    
    applicantsModal.addEventListener('click', (e) => {
        if (e.target === applicantsModal) {
            closeApplicantsModal();
        }
    });
// ============================================
// DELETE JOB POST (WITH APPLICATION CHECK)
// ============================================

async function deleteJob(jobId) {
  try {
    // Step 1: Check if there are any applications for this job
    const applicationsQuery = query(
      collection(db, 'applications'),
      where('jobId', '==', jobId)
    );
    
    const applicationsSnapshot = await getDocs(applicationsQuery);
    const applicationCount = applicationsSnapshot.size;
    
    // Step 2: If applications exist, warn the user
    if (applicationCount > 0) {
      const confirmMsg = `‚ö†Ô∏è WARNING: This job has ${applicationCount} application${applicationCount > 1 ? 's' : ''}.\n\n` +
                        `If you delete this job:\n` +
                        `‚Ä¢ All ${applicationCount} application${applicationCount > 1 ? 's' : ''} will be permanently deleted\n` +
                        `‚Ä¢ Applicants will lose their application history\n` +
                        `‚Ä¢ This action CANNOT be undone\n\n` +
                        `Do you want to proceed with deletion?`;
      
      if (!confirm(confirmMsg)) {
        return; // User cancelled
      }
      
      // Double confirmation for jobs with applications
      if (!confirm(`‚ö†Ô∏è FINAL CONFIRMATION\n\nAre you absolutely sure you want to delete this job and all ${applicationCount} application${applicationCount > 1 ? 's' : ''}?`)) {
        return; // User cancelled again
      }
    } else {
      // Step 3: If no applications, simple confirmation
      if (!confirm('Delete this job post?\n\nThis will remove it from the explore page.')) {
        return;
      }
    }
    
    // Step 4: Delete all applications first (if any)
    if (applicationCount > 0) {
      const deletePromises = [];
      applicationsSnapshot.forEach(appDoc => {
        deletePromises.push(deleteDoc(doc(db, 'applications', appDoc.id)));
      });
      
      await Promise.all(deletePromises);
      console.log(`‚úÖ Deleted ${applicationCount} application(s)`);
    }
    
    // Step 5: Delete the job post
    await deleteDoc(doc(db, 'jobs', jobId));
    
    // Step 6: Show success message
    alert(`‚úÖ Job deleted successfully!${applicationCount > 0 ? `\n${applicationCount} application(s) also removed.` : ''}`);
    
    // Step 7: Refresh the posts list
    loadUserPosts();
    
  } catch (error) {
    console.error('Error deleting job:', error);
    alert(`‚ùå Failed to delete job: ${error.message}`);
  }
}

// Make globally accessible
window.deleteJob = deleteJob;

    // ============================================
// TEMPORARY TEST FUNCTION - Add this after your other functions
// ============================================

window.testCompleteJob = async function(applicationId) {
  if (!applicationId) {
    // Get the first awaiting-payment job automatically
    try {
      const q = query(
        collection(db, 'applications'),
        where('status', '==', 'awaiting-payment')
      );
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        alert('No jobs in "awaiting-payment" status found.\n\nPlease complete Step 3 first to create a job with hours and amount.');
        return;
      }
      
      applicationId = snapshot.docs[0].id;
      console.log('Found application:', applicationId);
    } catch (error) {
      alert('Error finding job: ' + error.message);
      return;
    }
  }
  
  try {
    await updateDoc(doc(db, 'applications', applicationId), {
      status: 'completed',
      completedAt: serverTimestamp(),
      paymentId: 'test_pay_' + Date.now(),
      paymentStatus: 'completed'
    });
    
    alert('‚úÖ Job marked as completed for testing!\n\nRefresh and check "Completed Jobs" tab.');
    
    // Reload completed jobs if on that tab
    if (document.getElementById('completedList').classList.contains('active')) {
      loadCompletedJobs();
    }
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
    console.error(error);
  }
};

console.log('üí° Test function ready! Run: testCompleteJob() in console');
// ============================================
// RATING & FEEDBACK SYSTEM - STEP 7
// ============================================

let currentRatingAppId = null;
let selectedRating = 0;

// Open rating modal
function openRatingModal(applicationId, jobTitle) {
  currentRatingAppId = applicationId;
  selectedRating = 0;
  
  document.getElementById('rating-job-title').textContent = jobTitle;
  document.getElementById('feedback-text').value = '';
  document.getElementById('rating-text').textContent = 'Click to rate';
  document.getElementById('rating-text').style.color = 'var(--muted)';
  document.getElementById('rating-text').style.fontWeight = 'normal';
  
  // Reset stars
  document.querySelectorAll('.star').forEach(star => {
    star.classList.remove('active');
    star.textContent = '‚òÜ';
  });
  
  document.getElementById('rating-modal').style.display = 'flex';
}

// Close rating modal
function closeRatingModal() {
  document.getElementById('rating-modal').style.display = 'none';
  currentRatingAppId = null;
  selectedRating = 0;
}

// Update stars display
function updateStars(rating) {
  const stars = document.querySelectorAll('.star');
  const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
  
  stars.forEach((star, index) => {
    if (index < rating) {
      star.textContent = '‚òÖ';
      star.classList.add('active');
    } else {
      star.textContent = '‚òÜ';
      star.classList.remove('active');
    }
  });
  
  if (rating > 0) {
    document.getElementById('rating-text').textContent = ratingTexts[rating];
    document.getElementById('rating-text').style.color = '#ffc107';
    document.getElementById('rating-text').style.fontWeight = '600';
  } else {
    document.getElementById('rating-text').textContent = 'Click to rate';
    document.getElementById('rating-text').style.color = 'var(--muted)';
    document.getElementById('rating-text').style.fontWeight = 'normal';
  }
}

// Submit rating
async function submitRating() {
  if (selectedRating === 0) {
    alert('‚≠ê Please select a star rating before submitting.');
    return;
  }
  
  const feedback = document.getElementById('feedback-text').value.trim();
  
  try {
    const appRef = doc(db, 'applications', currentRatingAppId);
    
    await updateDoc(appRef, {
      providerRating: selectedRating,
      providerFeedback: feedback || '',
      ratedAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    
    alert(`‚úÖ Thank you for your review!\n\nRating: ${selectedRating} star${selectedRating > 1 ? 's' : ''}\n\n${feedback ? 'Your feedback has been posted.' : ''}`);
    
    closeRatingModal();
    loadCompletedJobs(); // Refresh to show rating
    
  } catch (error) {
    console.error('Error submitting rating:', error);
    alert('‚ùå Failed to submit rating: ' + error.message);
  }
}

// Make functions global
window.openRatingModal = openRatingModal;
window.closeRatingModal = closeRatingModal;
window.submitRating = submitRating;

// Star rating click handler
document.addEventListener('DOMContentLoaded', function() {
  const starContainer = document.getElementById('star-rating');
  if (starContainer) {
    starContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('star')) {
        selectedRating = parseInt(e.target.dataset.rating);
        updateStars(selectedRating);
      }
    });
  }
});

  </script>
  
</body>
</html>